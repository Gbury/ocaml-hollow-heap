machine:
  environment:
    OCAML_VERSION: 4.02.3
    OPAMYES: 1 # Automatically answer "yes" to every opam question
    OPAMVERBOSE: 1 # Better error reporting from Opam
dependencies:
  override:
    # Install opam from upstream: the versions of Ubuntu in CircleCI are too old
    - wget https://raw.github.com/ocaml/opam/master/shell/opam_installer.sh -O - | sh -s /usr/local/bin $OCAML_VERSION
    # Extra dependencies for tests
    - opam install ounit qtest
  cache_directories:
    - "~/.opam"
test:
  override:
    # All the warnings are fatal in CI. They are not fatal in the
    # `_tags` so that releases can compile with newer versions of the
    # compiler which have more warnings.
    - eval `opam config env` ; ocamlbuild -tag "warn_error(+a)" -classic-display test/tests.byte
    # Compile a second time, without the warning activated: if warning
    # fails, this will still give meaningful results.
    - eval `opam config env` ; ocamlbuild -classic-display test/tests.byte -- -output-junit-file test-result.xml
    # Compiles the documentation
    - eval `opam config env` ; ocamlbuild -classic-display lib.docdir/index.html
  post:
    # Report test result in junit format
    - mkdir -p $CIRCLE_TEST_REPORTS/ounit
    - cp test-result.xml $CIRCLE_TEST_REPORTS/ounit
    # Exports documentation as an artifact
    - cp -aT lib.docdir $CIRCLE_ARTIFACTS/doc
